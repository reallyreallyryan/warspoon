---
import BaseLayout from './BaseLayout.astro';
import JsonLd from '../components/JsonLd.astro';
import PostMeta from '../components/PostMeta.astro';
import ImageGallery from '../components/ImageGallery.astro';
import DownloadCard from '../components/DownloadCard.astro';
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
  title: string;
  description: string;
  date: Date;
  tags: string[];
  cover?: ImageMetadata;
  coverAlt?: string;
  images?: { src: ImageMetadata; alt: string }[];
  downloads?: { label: string; url: string; host?: string }[];
  lastModified?: Date;
}

const { title, description, date, tags, cover, coverAlt, images, downloads, lastModified } = Astro.props;

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  datePublished: date.toISOString(),
  ...(lastModified && { dateModified: lastModified.toISOString() }),
  ...(cover && { image: new URL(cover.src, Astro.site).href }),
  author: {
    '@type': 'Person',
    name: 'Warspoon',
  },
  publisher: {
    '@type': 'Organization',
    name: 'Warspoon',
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': Astro.url.href,
  },
};
---

<BaseLayout title={title} description={description} image={cover?.src} ogType="article" publishedDate={date} modifiedDate={lastModified}>
  <JsonLd schema={articleSchema} />
  <article>
    <header class="mb-8">
      <h1 class="text-3xl sm:text-4xl font-bold mb-4">{title}</h1>
      <PostMeta date={date} tags={tags} />
    </header>

    {cover && (
      <Image
        src={cover}
        alt={coverAlt ?? ''}
        widths={[600, 900, 1200]}
        sizes="(max-width: 1024px) 100vw, 960px"
        class="w-full rounded-lg mb-8"
        loading="eager"
      />
    )}

    <div class="prose prose-lg max-w-none">
      <slot />
    </div>

    <ImageGallery images={images ?? []} />

    {downloads && downloads.length > 0 && (
      <section class="mt-10">
        <h2 class="text-2xl font-bold mb-4">Downloads</h2>
        <div class="grid gap-3 sm:grid-cols-2">
          {downloads.map((dl) => (
            <DownloadCard label={dl.label} url={dl.url} host={dl.host} />
          ))}
        </div>
      </section>
    )}
  </article>
</BaseLayout>
